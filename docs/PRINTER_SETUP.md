# Printer Setup Guide

## Overview

The Kiosk app uses the browser's Print API to print queue tickets. This guide covers setting up thermal and standard printers for optimal ticket printing.

## Supported Printers

### Thermal Printers (Recommended)
- 80mm paper width (standard receipt printer)
- ESC/POS compatible printers
- USB or Network connected

**Recommended Models:**
- Epson TM-T20II/III
- Star TSP143III
- Bixolon SRP-350III
- Any 80mm ESC/POS thermal printer

### Standard Printers
- Any printer with custom paper size support
- Laser or inkjet printers
- 80mm x 120mm paper size

## Browser Compatibility

| Browser | Support | Notes |
|---------|---------|-------|
| Chrome | ✅ Full | Best support for silent printing |
| Edge | ✅ Full | Chromium-based, same as Chrome |
| Firefox | ⚠️ Limited | Requires user interaction |
| Safari | ⚠️ Limited | Requires user interaction |

**Recommended**: Use Chrome/Edge in kiosk mode for best results.

## Setup Instructions

### 1. Physical Setup

#### Thermal Printer
1. Connect printer to kiosk computer via USB or network
2. Install printer drivers from manufacturer
3. Set printer as **default printer** in system settings
4. Load 80mm thermal paper roll

#### Standard Printer
1. Connect printer to kiosk computer
2. Install printer drivers
3. Configure custom paper size (80mm x 120mm)
4. Set printer as default

### 2. Windows Setup

```powershell
# Add printer via Settings
Settings > Devices > Printers & scanners > Add a printer or scanner

# Configure paper size
1. Right-click printer > Printer properties
2. Go to "Device Settings" or "Paper/Quality"
3. Add custom paper size: 80mm x 120mm (3.15" x 4.72")
4. Set as default paper size

# Test print
Print a test page from printer properties
```

### 3. macOS Setup

```bash
# Add printer via System Preferences
System Preferences > Printers & Scanners > Add Printer

# Configure paper size
1. Select printer
2. Click "Options & Supplies"
3. Go to "Driver" tab
4. Add custom paper size: 80mm x 120mm
5. Set as default

# Test print
Print a test page
```

### 4. Linux Setup

```bash
# Install CUPS (if not already installed)
sudo apt-get install cups

# Add printer via CUPS web interface
# Open browser: http://localhost:631

# Configure printer
1. Administration > Add Printer
2. Select your printer
3. Set driver (Generic ESC/POS for thermal)
4. Add custom media size: 80mm x 120mm

# Test print
lp -d printer-name test-page.pdf
```

## Browser Configuration

### Chrome/Edge (Recommended)

#### Enable Silent Printing (Kiosk Mode)

```bash
# Windows
"C:\Program Files\Google\Chrome\Application\chrome.exe" --kiosk --kiosk-printing https://your-kiosk-url.web.app

# macOS
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --kiosk --kiosk-printing https://your-kiosk-url.web.app

# Linux
google-chrome --kiosk --kiosk-printing https://your-kiosk-url.web.app
```

#### Print Settings
1. Open Chrome settings: `chrome://settings/printing`
2. Set default printer
3. Disable print preview (for silent printing)
4. Set margins to "None"

### Firefox

Firefox requires user interaction for printing. Create a custom print preset:

1. File > Print
2. Configure settings:
   - Paper size: 80mm x 120mm
   - Margins: None (0mm)
   - Headers/Footers: None
   - Background graphics: Enabled
3. Save as preset

### Safari

Similar to Firefox, Safari requires user interaction. Configure print settings each time.

## Ticket Template Configuration

The ticket HTML is generated by Cloud Functions. Customize in:
`functions/src/utils/pdfGenerator.ts`

### Current Ticket Layout

```
┌────────────────────────────────┐
│   CITY GENERAL HOSPITAL        │
│   Jan 15, 2024 at 2:30 PM      │
├────────────────────────────────┤
│                                │
│   Your Queue Number            │
│        Q001                    │
│                                │
├────────────────────────────────┤
│   Scan to Register             │
│                                │
│     [QR CODE IMAGE]            │
│                                │
├────────────────────────────────┤
│ Please scan the QR code above  │
│ to complete your registration. │
│ You will be called when it's   │
│ your turn.                     │
├────────────────────────────────┤
│ Thank you for your patience    │
└────────────────────────────────┘
```

### Customize Ticket Dimensions

Edit `functions/.env`:

```env
QR_CODE_SIZE=200          # QR code size in pixels
TICKET_WIDTH_MM=80        # Ticket width in mm
TICKET_HEIGHT_MM=120      # Ticket height in mm
```

### Customize Ticket Content

Edit `functions/src/utils/pdfGenerator.ts`:

```typescript
export function generateTicketHTML(
  queueNumber: number,
  qrCodeDataUrl: string,
  timestamp: string,
  hospitalName: string
): string {
  // Modify HTML template here
  // Add logo, change colors, fonts, etc.
}
```

## Print Testing

### 1. Test Page

The kiosk app includes a printer test page:
`apps/kiosk/public/printer-test.html`

Open in browser to test print settings without generating queue numbers.

### 2. Test Print Script

```javascript
// Run in browser console
window.print();
```

### 3. Check Print Job Status

The app tracks print jobs in Firestore:

```javascript
// Query print jobs
db.collection('printJobs')
  .where('status', '==', 'failed')
  .get()
  .then(docs => {
    docs.forEach(doc => console.log(doc.data()));
  });
```

## Troubleshooting

### Issue: Print dialog appears instead of silent printing

**Solution:**
- Use Chrome/Edge with `--kiosk-printing` flag
- Set printer as default
- Disable print preview in browser settings

### Issue: Ticket is cut off or margins are wrong

**Solution:**
- Check paper size settings (80mm x 120mm)
- Set margins to "None" or 0mm
- Verify printer driver supports custom paper sizes
- Adjust CSS `@page` size in ticket template

### Issue: QR code doesn't scan

**Solution:**
- Increase QR code size in `.env` file
- Check QR error correction level (currently 'M')
- Ensure sufficient contrast (black on white)
- Test with different QR scanner apps

### Issue: Printer not found

**Solution:**
- Check physical connection (USB/Network)
- Install/reinstall printer drivers
- Set as default printer in system settings
- Check printer status (not paused/offline)

### Issue: Slow printing

**Solution:**
- Use thermal printer (faster than inkjet/laser)
- Reduce QR code size if too large
- Check network latency for network printers
- Update printer firmware

### Issue: Print quality is poor

**Solution:**
- Clean thermal printer head
- Check thermal paper quality
- Adjust printer density/darkness settings
- Replace thermal paper if faded

## Advanced Configuration

### ESC/POS Commands (Thermal Printers)

For direct ESC/POS printing (advanced):

```javascript
// Example: Cut paper after print
const escPosCut = '\x1B\x69'; // ESC i (partial cut)

// Add to ticket HTML (in <script> tag)
window.addEventListener('afterprint', () => {
  // Send ESC/POS command
  // Requires WebUSB or printer API
});
```

### Auto-Restart Print Service

Create a systemd service (Linux):

```bash
# /etc/systemd/system/kiosk-print.service
[Unit]
Description=Kiosk Print Service
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/google-chrome --kiosk --kiosk-printing https://your-kiosk-url.web.app
Restart=always
User=kiosk

[Install]
WantedBy=multi-user.target
```

### Printer Status Monitoring

Add printer status checks in Kiosk app:

```typescript
// Check printer status before printing
async function checkPrinterStatus(): Promise<boolean> {
  // Use browser's printer API
  // Or implement custom check
  return true; // printer is ready
}
```

## Security Considerations

1. **Network Printers**: Use secure network (VLAN)
2. **USB Printers**: Lock USB ports to prevent tampering
3. **Print Jobs**: Monitor failed prints for issues
4. **Paper Supply**: Alert when paper is low

## Maintenance

### Daily
- Check paper supply
- Verify printer is online
- Test print one ticket

### Weekly
- Clean thermal printer head
- Check for paper jams
- Review failed print jobs

### Monthly
- Update printer firmware
- Replace thermal paper roll
- Clean printer exterior

## Recommended Hardware Setup

### Complete Kiosk Setup
- **Computer**: Raspberry Pi 4 or Intel NUC
- **Display**: 10-15" touchscreen
- **Printer**: Epson TM-T20III (USB)
- **Enclosure**: Lockable kiosk enclosure
- **Network**: Ethernet connection (more reliable than WiFi)

### Cost Estimate
- Thermal Printer: $200-400
- Touchscreen: $150-300
- Computer: $100-500
- Enclosure: $200-500
- **Total**: $650-1700

## Support

For printer-specific issues, contact:
- Printer manufacturer support
- Hospital IT department
- System integrator

For app-related issues, check:
- Firebase Console logs
- Browser console errors
- `printJobs` collection in Firestore
